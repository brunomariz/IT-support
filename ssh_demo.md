# SSH Demo

This file is a guide for creating an SSH client and server on separate containers for demonstration purposes.

### Prerequisites

- [Docker](https://docs.docker.com/engine/install/ubuntu/)

### Contents

- [Option 1: using server user's password](#option-1-using-server-users-password)
- [Option 2: using public key authentication](#option-2-using-public-key-authentication)
- [Cleanup](#cleanup)

## Option 1: using server user's password

For this ssh connection, the server user's password must be known by the client and entered every time a connection is made. 

### Create containers

1. Open two terminal windows
2. Run ubuntu containers on both terminals

```shell
docker run --rm -it ubuntu /bin/bash
```

To check this step, you can open a new third terminal window on your host machine, 
and run `docker ps` to see the new containers running. The output should look something
like this:

```console
~$ docker ps
CONTAINER ID   IMAGE     COMMAND       CREATED          STATUS          PORTS     NAMES
4317b6ea601c   ubuntu    "/bin/bash"   34 seconds ago   Up 34 seconds             heuristic_meninsky
b9eaf4228eec   ubuntu    "/bin/bash"   38 seconds ago   Up 38 seconds             lucid_williamson
```

3. Run `apt update` on both containers

```shell
apt update
```

### Setup server container 

4. Choose arbitrarily which container is the client and the server. On the terminal window running the 
container you chose as the server, run the command:

```shell
apt install openssh-server
```

5. Start the ssh server

```shell
service ssh start
```

6. Create a new user on the server container, on which the client will log in

```shell
adduser brini
```

Fill in the information and make sure to remember the password, as it will be used when we connect from the client

```console
New password: 
Retype new password: 
passwd: password updated successfully
Changing the user information for brini
Enter the new value, or press ENTER for the default
	Full Name []: 
	Room Number []: 
	Work Phone []: 
	Home Phone []: 
	Other []: 
Is the information correct? [Y/n] Y
```

7. You can now switch to the new user with the command `su - USER` and make modifications on the files if you
want to see them on the client

```shell
su - brini
```

```console
brini@4317b6ea601c:~$ mkdir test
brini@4317b6ea601c:~$ ls 
test
```

8. Finally, get the server container's IP address. Keep this address in mind, as it will be used when we connect from the client

```shell
hostname -I
```

```
172.17.0.3 
```

### Setup client container

9. On the terminal window running the container you chose as client, 
run the command:

```shell
apt install openssh-client
```

### Create connection

10. Create the ssh connection with the command `ssh USER@IP_ADDRESS`

```shell
ssh brini@172.17.0.3
```

### Make changes

11. After inserting the password, use the server remotely from the client container

```console
brini@4317b6ea601c:~$ echo "hello!" >> test/file.txt
```

### See changes on server

12. Back on the server container, check if remote changer appear

```console
brini@4317b6ea601c:~$ cd test/
brini@4317b6ea601c:~/test$ ls
file.txt
brini@4317b6ea601c:~/test$ cat file.txt 
hello!
```

## Option 2: using public key authentication

For this ssh connection the server user's password has to be entered only one time, when adding the key.

### Create containers

1. Open two terminal windows
2. Run ubuntu containers on both terminals

```shell
docker run --rm -it ubuntu /bin/bash
```

To check this step, you can open a new third terminal window on your host machine, 
and run `docker ps` to see the new containers running. The output should look something
like this:

```console
~$ docker ps
CONTAINER ID   IMAGE     COMMAND       CREATED          STATUS          PORTS     NAMES
4317b6ea601c   ubuntu    "/bin/bash"   34 seconds ago   Up 34 seconds             heuristic_meninsky
b9eaf4228eec   ubuntu    "/bin/bash"   38 seconds ago   Up 38 seconds             lucid_williamson
```

3. Run `apt update` on both containers

```shell
apt update
```

### Setup server container 

4. *Setup your server container exactly as described for [Option 1](#setup-server-container)

### Setup client container

For this option, the client container has a few extra steps, that will allow us to connect through a public/private key pair.

5. On the terminal window running the container you chose as client, 
run the command:

```shell
apt install openssh-client
```

6. Generate the client's key pair

```shell
ssh-keygen
```

Here you can choose a password that will be used for your ssh connections instead of the server user's password as in option 1.

You can view the keys generated by this command on the `/root/.ssh/` directory

```console
root@cda02840f7dd:/# ls -la /root/.ssh/
total 16
drwx------ 2 root root 4096 Dec 16 22:08 ./
drwx------ 1 root root 4096 Dec 16 22:08 ../
-rw------- 1 root root 2602 Dec 16 22:08 id_rsa
-rw-r--r-- 1 root root  571 Dec 16 22:08 id_rsa.pub
```

7. Add the client's public key to the server user's `/home/.ssh/authorized_keys` file. This will be done using the IP from the server container obtained in step 4
with the command `ssh-copy-id -f SERVER_USER@SERVER_IP_ADDRESS`

```shell
ssh-copy-id brini@172.17.0.3
```

This will prompt you to insert the server user's password. Note this will be the only time this password will have to be typed.
After the password is entered, the following message should appear

```console
Number of key(s) added: 1

Now try logging into the machine, with:   "ssh 'brini@172.17.0.5'"
and check to make sure that only the key(s) you wanted were added.
```

Optional: you can check the server container's ~/.ssh directory and see the new authorized_keys file

```console
brini@d1005a68bad6:~$ cat .ssh/authorized_keys 
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCxRkq/22w1b5CRHCmmlB//fD0F0VnePBq+8mAYbrSsdvVRFl/PKU2+ou/WmbuHuNV6QfnqABWe0/GI1od0JqSX7AwuH4ORYEt6WNtVFeNu5SSLkEZVqCP6+Ea431wuFFRBvA952xPdiP+3+mF57zkrKLlMNt6oKyVzdhvgJbi1p7Edem3ZqfsL7m9uEi1BanlCbva9/UHwSg2btCMRiqkcxtLdlo5MbSIWfKZn1XmvfiZgZ6wAsAfDer88yb2lXen5fecX/qH14ZVCqIVLT4GmBPLFUcas9xukGzjIGPr0frOy4TjpTALUG+bN+xPxOQn3rKrGjGf+Uta0s+lZRIM05dYqaj+2hCJt0lMtIg6+apjb3vgXGiH7Sit8Ey8D71Acsl+1y9aLUFcou/64TPuvaj6qEIlTQOLo4H0wLoKnfE/9KmUHuL9tNHgXL7kR9KvaSzgJ4MWrLay3AowjMD3VQTan61ZGYQ3IbWcgV2i9XMdcX3PzV8+jXSmXzcx0zWs= root@cda02840f7dd
```

You can also compare this file's contents to the client's public key

```console
root@cda02840f7dd:/# # ON THE CLIENT CONTAINER   
root@cda02840f7dd:/# cat /root/.ssh/id_rsa.pub 
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCxRkq/22w1b5CRHCmmlB//fD0F0VnePBq+8mAYbrSsdvVRFl/PKU2+ou/WmbuHuNV6QfnqABWe0/GI1od0JqSX7AwuH4ORYEt6WNtVFeNu5SSLkEZVqCP6+Ea431wuFFRBvA952xPdiP+3+mF57zkrKLlMNt6oKyVzdhvgJbi1p7Edem3ZqfsL7m9uEi1BanlCbva9/UHwSg2btCMRiqkcxtLdlo5MbSIWfKZn1XmvfiZgZ6wAsAfDer88yb2lXen5fecX/qH14ZVCqIVLT4GmBPLFUcas9xukGzjIGPr0frOy4TjpTALUG+bN+xPxOQn3rKrGjGf+Uta0s+lZRIM05dYqaj+2hCJt0lMtIg6+apjb3vgXGiH7Sit8Ey8D71Acsl+1y9aLUFcou/64TPuvaj6qEIlTQOLo4H0wLoKnfE/9KmUHuL9tNHgXL7kR9KvaSzgJ4MWrLay3AowjMD3VQTan61ZGYQ3IbWcgV2i9XMdcX3PzV8+jXSmXzcx0zWs= root@cda02840f7dd
```

8. Now, you can connect via ssh using the password you set on step 6 with the command `ssh SERVER_USER@SERVER_IP`

```shell
ssh brini@172.17.0.3
```

### Make changes

You can see the files in the server to play with the connection just as in option 1

9. After inserting the ssh key password, use the server remotely from the client container

```console
brini@d1005a68bad6:~$ echo "hello!" >> test/file.txt
```

### See changes on server

10. Back on the server container, check if remote changer appear

```console
brini@d1005a68bad6:~$ cd test
brini@d1005a68bad6:~/test$ ls
file.txt
brini@d1005a68bad6:~/test$ cat file.txt
hello!
```

## Cleanup

To quit the opened containers, use the command `Ctrl+D` to logout and exit.
